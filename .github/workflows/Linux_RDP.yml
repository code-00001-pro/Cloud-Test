name: Linux RDP (Ubuntu XFCE)

on:
  workflow_dispatch:

jobs:
  linux-rdp:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
    - name: Update system
      run: |
        sudo apt update -y
        sudo apt upgrade -y

    - name: Install Desktop + RDP
      run: |
        sudo apt install -y xfce4 xfce4-goodies xrdp dbus-x11
        sudo systemctl enable xrdp
        sudo adduser xrdp ssl-cert
        echo "xfce4-session" | sudo tee /etc/skel/.xsession

    - name: Create RDP user (FIXED)
      run: |
        sudo useradd -m -s /bin/bash rdpuser
        echo "rdpuser:rdp123" | sudo chpasswd
        sudo usermod -aG sudo rdpuser

        sudo bash -c 'echo "exec startxfce4" > /home/rdpuser/.xsession'
        sudo chown rdpuser:rdpuser /home/rdpuser/.xsession
        sudo chmod 644 /home/rdpuser/.xsession

        sudo systemctl restart xrdp

    - name: Install Tailscale
      run: |
        curl -fsSL https://tailscale.com/install.sh | sh

    - name: Start Tailscale
      env:
        TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      run: |
        sudo tailscale up --authkey=${TAILSCALE_AUTHKEY} --hostname=linux-rdp

    - name: Show connection info
      run: |
        echo "=============================="
        echo "RDP USERNAME : rdpuser"
        echo "RDP PASSWORD : rdp123"
        echo "TAILSCALE IP :"
        tailscale ip -4
        echo "RDP PORT     : 3389"
        echo "=============================="

    - name: Keep VM Alive (6 hours)
      run: |
        echo "Linux RDP is running..."
        sleep 21600
